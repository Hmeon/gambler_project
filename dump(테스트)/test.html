<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>Baccarat Chip Simulator</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1;
      background-color: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
    }

    #addChipButton {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    #addChipButton:hover {
      background-color: #218838;
    }

    #betTypeSelect {
      margin-left: 10px;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <div id="controls">
    <button id="addChipButton">칩 추가</button>
    <select id="betTypeSelect">
      <option value="bet-player-1">Player 1 (Red)</option>
      <option value="bet-banker-1">Banker 1 (Black)</option>
      <option value="bet-tie-">Tie (Blue)</option>
      <option value="bet-player-pair-">Player Pair (Red)</option>
      <option value="bet-banker-pair-">Banker Pair (Black)</option>
    </select>
  </div>

  <!-- THREE.js 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- GLTFLoader -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <!-- CANNON.js 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>

  <script>
    // 기본 변수 설정
    let scene, camera, renderer, world, demo = [];
    let app = {
      gamePlay: {
        spining: false,
        currentBetValue: 10 // 베팅 금액 설정 (예: 10)
      },
      audios: {
        chipStackAudio: null // 실제 오디오 객체로 초기화
      },
      GLTFLoader: new THREE.GLTFLoader(),
      currentBets: {},
      stacks: {} // 베팅 유형별 스택 정보 저장
    };

    // 텍스처 로더 초기화
    const textureLoader = new THREE.TextureLoader();
    const chipTextures = {
      "bet-player-1": textureLoader.load('red_chip.png'),    // Player 1 베팅: 빨간색 칩
      "bet-banker-1": textureLoader.load('black_chip.png'), // Banker 1 베팅: 검은색 칩
      "bet-tie-": textureLoader.load('blue_chip.png'),      // Tie 베팅: 파란색 칩
      "bet-player-pair-": textureLoader.load('red_chip.png'),    // Player Pair 베팅: 빨간색 칩
      "bet-banker-pair-": textureLoader.load('black_chip.png')  // Banker Pair 베팅: 검은색 칩
      // 추가적인 베팅 유형에 따른 텍스처 매핑 가능
    };

    // 텍스처 설정 (투명도 지원)
    for (let key in chipTextures) {
      chipTextures[key].encoding = THREE.sRGBEncoding;
      chipTextures[key].wrapS = THREE.ClampToEdgeWrapping;
      chipTextures[key].wrapT = THREE.ClampToEdgeWrapping;
      chipTextures[key].repeat.set(1, 1);
    }

    // 베팅 유형별 스택의 기본 위치 정의
    const stackBasePositions = {
      "bet-player-1": new THREE.Vector3(-0.05, 0, 0.05),
      "bet-banker-1": new THREE.Vector3(0.05, 0, 0.05),
      "bet-tie-": new THREE.Vector3(0, 0, -0.05),
      "bet-player-pair-": new THREE.Vector3(-0.05, 0, -0.05),
      "bet-banker-pair-": new THREE.Vector3(0.05, 0, -0.05)
    };

    // 3D 씬 초기화
    function initThreeJS() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x202020);

      camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.01, // 근접 클리핑을 줄임
        1000
      );
      camera.position.set(0, 0.1, 0.3); // 칩이 화면 중앙에 적절히 보이도록 위치 조정
      camera.lookAt(new THREE.Vector3(0, 0, 0)); // 카메라가 칩을 바라보도록 설정

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // 조명 추가
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(5, 10, 7.5);
      scene.add(directionalLight);

      // 바닥 생성
      const floorGeometry = new THREE.PlaneGeometry(1, 1); // 스케일을 줄임
      const floorMaterial = new THREE.MeshPhongMaterial({ color: 0x808080 });
      const floor = new THREE.Mesh(floorGeometry, floorMaterial);
      floor.rotation.x = -Math.PI / 2;
      scene.add(floor);
    }

    // 물리 엔진 초기화
    function initCannonJS() {
      world = new CANNON.World();
      world.gravity.set(0, -9.82, 0);
      world.broadphase = new CANNON.NaiveBroadphase();
      world.solver.iterations = 10;

      // 바닥과 칩에 적용할 마찰력과 바운스 설정
      const groundMaterial = new CANNON.Material('groundMaterial');
      const chipMaterial = new CANNON.Material('chipMaterial');

      // 마찰력 설정
      const contactMaterial = new CANNON.ContactMaterial(groundMaterial, chipMaterial, {
        friction: 1.7, // 마찰력 증가 (칩이 잘 안 굴러가게 만듦)
        restitution: 0.9 // 반발력 감소 (칩이 튕기지 않게)
      });
      world.addContactMaterial(contactMaterial);

      // 바닥 물리 바디 추가
      const floorBody = new CANNON.Body({
        mass: 0, // 고정
        shape: new CANNON.Plane(),
        material: groundMaterial // 바닥에 마찰력 적용
      });
      floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
      world.addBody(floorBody);
    }

    /**
     * 베팅 유형별 핸들러 객체
     */
    const betTypeHandlers = {
      "bet-player-1": function () {
        console.log("Player bets on Player 1");
        app.currentBets.player1 = (app.currentBets.player1 || 0) + app.gamePlay.currentBetValue;
        decBalance();
      },
      "bet-banker-1": function () {
        console.log("Player bets on Banker 1");
        app.currentBets.banker1 = (app.currentBets.banker1 || 0) + app.gamePlay.currentBetValue;
        decBalance();
      },
      "bet-tie-": function () {
        console.log("Player bets on Tie");
        app.currentBets.tie = (app.currentBets.tie || 0) + app.gamePlay.currentBetValue;
        decBalance();
      },
      "bet-player-pair-": function () {
        console.log("Player bets on Player Pair");
        app.currentBets.playerPair = (app.currentBets.playerPair || 0) + app.gamePlay.currentBetValue;
        decBalance();
      },
      "bet-banker-pair-": function () {
        console.log("Player bets on Banker Pair");
        app.currentBets.bankerPair = (app.currentBets.bankerPair || 0) + app.gamePlay.currentBetValue;
        decBalance();
      },
      // 추가적인 베팅 유형 핸들러 추가 가능
    };

    /**
     * 베팅 유형에 따라 게임 상태를 업데이트하는 함수 (핸들러 객체 사용)
     * @param {string} betType - 베팅 유형
     */
    function processBetType(betType) {
      if (betTypeHandlers[betType]) {
        betTypeHandlers[betType]();
      } else {
        console.log("Unknown bet type:", betType);
      }
    }

    /**
     * 잔액을 감소시키는 함수
     */
    function decBalance() {
      // 잔액 감소 로직 구현
      app.currentBalance = app.currentBalance || 1000; // 초기 잔액 설정
      app.currentBalance -= app.gamePlay.currentBetValue;
      console.log("잔액:", app.currentBalance);
    }

    /**
     * 칩을 게임에 추가하는 함수
     * @param {string} betType - 베팅 유형
     */
    function addChip(betType) {
      // 현재 게임이 스피닝 중인지 확인
      if (app.gamePlay.spining === true) {
        return;
      }

      // 칩 추가 소리 재생
      if (app.audios.chipStackAudio) {
        app.audios.chipStackAudio.currentTime = 0; // 재생 위치 초기화
        app.audios.chipStackAudio.play();
      }

      // 베팅 유형에 따른 텍스처 선택
      let texture = chipTextures[betType];

      if (!texture) {
        console.log("Unknown bet type for texture:", betType);
        return;
      }

      // 베팅 유형별 스택 정보 초기화
      if (!app.stacks[betType]) {
        app.stacks[betType] = {
          count: 0,
          basePosition: stackBasePositions[betType] || new THREE.Vector3(0, 0, 0)
        };
      }

      const stack = app.stacks[betType];
      const stackHeight = stack.count * 0.005; // 칩의 두께만큼 높이 증가

      // 칩 위치 설정
      const position = stack.basePosition.clone();
      position.y += stackHeight;

      // 칩에 약간의 오프셋 추가
      const offsetX = (Math.random() - 0.5) * 0.005; // -0.0025 ~ 0.0025
      const offsetZ = (Math.random() - 0.5) * 0.005; // -0.0025 ~ 0.0025
      position.x += offsetX;
      position.z += offsetZ;

      // 원형 디스크 생성 (지오메트리 크기 조정)
      const geometry = new THREE.CylinderGeometry(0.02, 0.02, 0.005, 64); // 반지름 0.02m, 높이 0.005m, 세그먼트 수 64
      const material = new THREE.MeshPhongMaterial({
        map: texture,
        shininess: 100,
        transparent: true,    // 투명도 사용
        alphaTest: 0.5,       // 투명도 테스트 임계값
        side: THREE.DoubleSide // 양면 렌더링
      });
      const chip = new THREE.Mesh(geometry, material);

      // 칩 위치 설정
      chip.position.copy(position);

      // 칩을 약간 회전시킴
      chip.rotation.y = Math.random() * Math.PI * 2;

      scene.add(chip);

      // 물리 바디 설정 (필요한 경우에만 사용)
      const body = new CANNON.Body({
        mass: 0.05, // 질량 조정 (예: 0.05kg)
        position: new CANNON.Vec3(position.x, position.y, position.z),
        shape: new CANNON.Cylinder(0.02, 0.02, 0.005, 64),
        material: new CANNON.Material('chipMaterial')
      });
      world.addBody(body);

      // 회전 잠금 (회전 방지)
      if (body.angularFactor) {
        body.angularFactor.set(0, 0, 0); // 모든 축의 회전 잠금
      } else {
        // 대체 방법: angularFactor가 undefined일 경우 직접 할당
        body.angularFactor = new CANNON.Vec3(0, 0, 0);
      }

      // 초기 속도와 각속도 0으로 설정
      body.velocity.setZero();
      body.angularVelocity.setZero();

      // 애니메이션 루프에서 동기화
      demo.push({ mesh: chip, body: body });

      // 베팅 유형에 따른 게임 상태 업데이트
      processBetType(betType);

      // 스택 카운트 증가
      stack.count += 1;
    }

    // 애니메이션 루프
    function animate() {
      requestAnimationFrame(animate);

      // 물리 엔진 업데이트
      world.step(1 / 60);

      // 물리 바디와 메쉬 동기화
      if (demo.length > 0) {
        demo.forEach(item => {
          // 속도와 각속도를 0으로 설정하여 움직이지 않게 함
          item.body.velocity.setZero();
          item.body.angularVelocity.setZero();

          // 위치와 회전 동기화
          item.mesh.position.copy(item.body.position);
          item.mesh.quaternion.copy(item.body.quaternion);
        });
      }

      renderer.render(scene, camera);
    }

    // 오디오 초기화 함수
    function initAudio() {
      const audio = new Audio('../audio/chip-sound.mp3'); // 실제 오디오 파일 경로로 변경
      audio.volume = 0.5; // 볼륨 조절 (0.0 ~ 1.0)
      app.audios.chipStackAudio = audio;
    }

    // 버튼 클릭 이벤트 설정
    document.getElementById('addChipButton').addEventListener('click', () => {
      // 선택된 베팅 유형 가져오기
      const betTypeSelect = document.getElementById('betTypeSelect');
      const betType = betTypeSelect.value;

      addChip(betType);
    });

    // 창 크기 변경 시 카메라와 렌더러 업데이트
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 초기화 및 애니메이션 시작
    initThreeJS();
    initCannonJS();
    initAudio(); // 오디오 초기화
    animate();
  </script>

</body>

</html>
